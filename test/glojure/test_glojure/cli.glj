(ns glojure.test-glojure.cli
  (:use glojure.test)
  (:require [glojure.string :as str]))

(defmacro #^{:private true} test-that
  "Provides a useful way for specifying the purpose of tests. If the first-level
  forms are lists that make a call to a glojure.test function, it supplies the
  purpose as the msg argument to those functions. Otherwise, the purpose just
  acts like a comment and the forms are run unchanged."
  [purpose & test-forms]
  (let [tests (map
               #(if (= (:ns (meta (resolve (first %))))
                       (the-ns 'glojure.test))
                  (concat % (list purpose))
                  %)
               test-forms)]
    `(do ~@tests)))

(defn run-cli-cmd [& args]
  (let [bytes-to-string (fn [bytes]
                          (if (nil? bytes)
                            ""
                            (apply str (map char (seq bytes)))))
        cmd (apply os$exec.Command args)
        [output err] (.CombinedOutput cmd)]
    [(bytes-to-string output) (bytes-to-string err)]))

(def glj
  (let [[out err] (run-cli-cmd "find" "bin" "-name" "glj" "-executable")]
    (if (and (seq out) (empty? err))
      (first (str/split-lines out))
      (throw (Exception. (str "Failed to find glj bin: " err))))))

(deftest help-flag-test
  (test-that
   "glj --help flag works correctly"
   (let [[out err] (run-cli-cmd glj "--help")]
     (is (re-matches
          #"(?s).*Glojure v\d+\.\d+\.\d+.*Usage: glj.*Options:.*-e.*--version.*-h.*--help.*Examples:.*"
          out)
         "Command should output help information")
     (is (re-matches
          #"(?s).*Environment Variables:.*GLJPATH.*PATH of directories for \.glj libraries.*"
          out)
         "Help should document GLJPATH environment variable")
     (is (empty? err) "Command should not return an error"))))

(deftest e-flag-test
  (test-that
   "glj -e flag works correctly"
   (let [[out err] (run-cli-cmd glj "-e" "(* 6 7)")]
     (is (= out "42\n") "Command should output 42")
     (is (empty? err) "Command should not return an error"))))

(deftest version-flag-test
  (test-that
   "glj --version flag works correctly"
   (let [[out err] (run-cli-cmd glj "--version")]
     (is (re-matches #"glojure v\d+\.\d+\.\d+\n" out)
         "Command should output version")
     (is (empty? err) "Command should not return an error"))))

(run-tests)
